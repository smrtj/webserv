<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover E-Bike - Online Waiver & Rental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import SMRTPay widget -->
    <script src="/assets/SMRT-Pay/smrtpay.js"></script>
    <!-- Optional: 11Labs (toggleable as needed) -->
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
    <style>
        /* ... [keep all your original styles here] ... */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <!-- ... [PAGE 1 and PAGE 2 as before, unchanged] ... -->

        <!-- Page 3: REPLACED with widget mount point -->
        <div id="page3" class="form-section">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Step 3: Payment Details</h2>
            <div id="smrt-pay"></div>
            <div id="page3Error" class="error-message"></div>
            <div class="flex justify-between mt-6">
                <button onclick="goBackToPageOnPayment()" class="btn btn-secondary">Back</button>
            </div>
        </div>

        <div id="confirmationPage" class="form-section text-center">
            <h2 class="text-xl font-semibold mb-4 text-green-600">Reservation Confirmed!</h2>
            <p class="text-gray-700 mb-2">Thank you for your reservation with Discover E-Bike.</p>
            <p class="text-gray-700 mb-6">A confirmation email has been sent to you. We look forward to seeing you!</p>
            <p class="text-sm text-gray-600">Discover E-Bike<br>109 N Oak St, Port Angeles, WA 98362<br>360.460.1218</p>
        </div>
    </div>

<script>
    let currentPage = 1;
    let adultWaiverData = {};
    let minorWaiverData = [];

    // ...[keep all your existing waiver/participant page logic]...

    // --- PAGE NAVIGATION ---
    function showPage(pageNumber) {
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        if (typeof pageNumber === 'number') {
            document.getElementById(`page${pageNumber}`).classList.add('active');
        } else {
            // for confirmationPage etc.
            document.getElementById(pageNumber).classList.add('active');
        }
        currentPage = pageNumber;
        window.scrollTo(0,0);
        // If page 3 (payment), init the widget
        if (pageNumber === 3) {
            initSmrtPayWidget();
        }
    }

    // ...[rest of your existing logic for waiver pages, unchanged]...

    // --------------- SMRTPay Widget Integration ---------------

    function initSmrtPayWidget() {
        // Optional: remove any previous widget in case user comes back and forth
        const targetDiv = document.getElementById('smrt-pay');
        targetDiv.innerHTML = "";

        // You can pass any data needed for the widget (e.g., name/email for receipts)
        window.SMRTPayWidget.init({
            env: '/var/www/html/showcase/ebike/.env',
            mode: 'bin+token',      // or whatever mode you need
            //total: 60,              // Replace with dynamic rental amount if needed
            ACH: false,             // true if you want to show ACH
            saveRealACH: false,     // true if you want to save ACH tokens
            cashDiscount: false,    // true for cash discount logic
            debug: true,            // set to false for production
            targetDiv: '#smrt-pay',

            // Optionally, pass extra fields for overlays, branding, user data, etc
            extra: {
                customerName: adultWaiverData?.name || '',
                customerEmail: adultWaiverData?.email || ''
            },

            // Called when payment is successful
            onSuccess: function(paymentResult) {
                // You can now store waiver info + payment token on your backend
                // paymentResult will include status, token, etc.
                // You might want to POST all data to your server here.
                // Example:
                /*
                fetch('/api/save-waiver', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        waiver: adultWaiverData,
                        minors: minorWaiverData,
                        payment: paymentResult
                    })
                }).then(() => showPage('confirmationPage'));
                */
                showPage('confirmationPage');
            },

            // Called if payment fails or is cancelled
            onError: function(error) {
                document.getElementById('page3Error').innerText = "Payment failed: " + (error.message || "Please try again.");
            }
        });
    }

    // --- Initialize first page
    showPage(1);
</script>

<!-- Optionally, 11Labs Voice Widget, default ON -->
<elevenlabs-convai agent-id="agent_01jyjgxereekmrv21389k3fy2s"></elevenlabs-convai>

</body>
</html>

